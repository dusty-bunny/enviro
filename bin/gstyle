#!/bin/bash

if [ $# -eq 0 ] ; then
        echo "Please supply one or more filenames to process" >&2
        exit 1
fi

ASTYLE=astyle

#
# wrap a call with a printout.
#
run()
{
        echo "::: $*"
        $@
}

#
# Figure out which astyle/astyled to use and
# where to find it.
#
set_astyle_path()
{
#   ASTYLE=astyle
    if [ "$DBG" == "dbg" ] ; then
            ASTYLE="${ASTYLE}d"
    fi

    HOST_OFFSET=/
    HOST_OFFSET=/zeus/
    ASTYLE_SRCROOT=${HOME}/src
    ASTYLE_GITDIR=astyle-github
    ASTYLE_BLDROOT=AStyle/build/gcc
    PATHS_ASTYLE=( "/zeus/" "/zglue/" "/" )

    for path in ${PATHS_ASTYLE[@]} ; do
        ASTYLE_PATH=${ASTYLE_SRCROOT}${path}${ASTYLE_GITDIR}/${ASTYLE_BLDROOT}/bin/${ASTYLE}
        if [  -f "$ASTYE_PATH" ] ; then
            break
        else
            continue 
        fi
        echo "No astyle found." >&2
        return 2
    done
    echo "Found $ASTYLE_PATH" >&2
    echo $ASTYLE_PATH
}

while [ $# -ne 1 ] ; do
        case "$1" in
        -d) DBG=dbg
            ;;
        esac
        shift
done

TARGET_DIR="$HOME/src/zglue/official/nuttx-official/arch/arm/src/imxrt"
[ ! -d "$TARGET_DIR" ] && TARGET_DIR="$HOME/src/zeus/NuttX/nuttx-official/arch/arm/src/imxrt"
pushd $TARGET_DIR || exit

declare -A Styles
Styles["nuttx"]="${HOME}/bin/astyle-nuttx"

date +"== %m::%S::%h-%d"
ls -l test.c

CMD=( "git" "checkout" "." )
run ${CMD[@]}
ls -l test.c

CMD=( "git" "status" )
run ${CMD[@]}

if ! ASTYLE_PATH="$(set_astyle_path)" ; then
        echo -e "\n==================================\n" >&2
        exit 1
fi

CMD=( "${ASTYLE_PATH}" "--options=${Styles[nuttx]}" "$@" )
run "${CMD[@]}"

popd

