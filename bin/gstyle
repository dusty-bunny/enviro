#!/bin/bash

ASTYLE=astyle
SYS_SRCROOT=${HOME}/src
PATHS_SRCS=( "/zeus/" "/zglue/" "/" )

#
# Wrap echo with a redirect to stderr
#
err_echo()
{
        echo -e "$@" >&2
}

if [ $# -eq 0 ] ; then
        err_echo "Please supply one or more filenames to process"
        exit 1
fi

#
# wrap a call with a printout.
#
run()
{
        echo "::: $*"
        $@
}

#
# Figure out which astyle/astyled to use and
# where to find it.
#
set_astyle_path()
{
#   ASTYLE=astyle
    if [ "$DBG" == "dbg" ] ; then
            ASTYLE="${ASTYLE}d"
    fi

    ASTYLE_GITDIR=astyle-github
    ASTYLE_BLDROOT=AStyle/build/gcc

    for path in ${PATHS_SRCS[@]} ; do
        ASTYLE_PATH=${SYS_SRCROOT}${path}${ASTYLE_GITDIR}/${ASTYLE_BLDROOT}/bin/${ASTYLE}
        if [  -f "$ASTYLE_PATH" ] ; then
            break
        fi
        ASTYLE_PATH=""
    done
    if [ -z "$ASTYLE_PATH" ] ; then
        err_echo "No astyle found."
        return 2
    fi
    err_echo "Found $ASTYLE_PATH"
    echo $ASTYLE_PATH
}

while [ $# -ne 1 ] ; do
        case "$1" in
        -d) DBG=dbg
            ;;
        esac
        shift
done

# TARGET_DIR="$HOME/src/zglue/official/nuttx-official/arch/arm/src/imxrt"
TARGET_DIR="$HOME/src/zeus/NuttX/official/nuttx-official/arch/arm/src/imxrt"
[ ! -d "$TARGET_DIR" ] && TARGET_DIR="$HOME/src/zeus/NuttX/nuttx-official/arch/arm/src/imxrt"
pushd $TARGET_DIR || exit

declare -A Styles
Styles["nuttx"]="${HOME}/bin/astyle-nuttx"

date +"== %m::%S::%h-%d"
ls -l test.c

CMD=( "git" "checkout" "." )
run ${CMD[@]}
ls -l test.c

CMD=( "git" "status" )
run ${CMD[@]}

if ! ASTYLE_PATH="$(set_astyle_path)" ; then
        exit 1
fi

CMD=( "${ASTYLE_PATH}" "--options=${Styles[nuttx]}" "$@" )
run "${CMD[@]}"

popd

