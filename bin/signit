#!/bin/bash


export SIGN_LOGFILE=/tmp/log.signit

#
# Echo stuff to stderr
#
echo_dbg()
{
        return
        echo "$@" |& tee -a $SIGN_LOGFILE
}

#
# Echo stuff to stderr
#
echo_err()
{
        echo "$@" |& tee -a $SIGN_LOGFILE
}

#
# Print out variables and values.
#
echo_vars()
{
        local Vars=

        Vars="$@"
        for var in $Vars ; do
                echo_dbg $var ${!var}
        done
}

rm -f $SIGN_LOGFILE
KEY_NAME=hoops

#
# Make sure the file to sign is in the CWD.
#
TARGET="$(basename $1)"
RELOCATE="$(dirname $1)"
pushd $RELOCATE |& tee -a $SIGN_LOGFILE
[ ! -f "$TARGET" ] && echo_err "Not found <$TARGET>" && exit 5
echo_dbg "Sign $TARGET"
ROOT="${TARGET%.*}"

[ -f "$ROOT" ] && rm -f "$ROOT"
[ -f "${ROOT}.gpg" ] && rm -f "${ROOT}.gpg"

#
# Generate a random ascii value.
#
SUFX="$(mktemp -u XXX)"

# GPG_OPTS=( "--verbose" "--clear-sign" "-o" "${ROOT}.${SUFX}" "$TARGET" )
# GPG_OPTS=( "--verbose" "--sign" "$TARGET" )
# GPG_OPTS=( "--verbose" "--local-user" "$KEY_NAME" "--output" "$ROOT" "--clear-sign" "$TARGET" )
GPG_OPTS=( "-vvvv" "--debug-level" "guru" "--output" "$ROOT" "--local-user" "$KEY_NAME" "--clear-sign" "$TARGET" )
# GPG_OPTS=( "--verbose" "--detach-sign"  "$TARGET" )

echo_vars TARGET ROOT SUFX
echo "gpg command: gpg ${GPG_OPTS[@]}" |& tee -a $SIGN_LOGFILE
gpg ${GPG_OPTS[@]} |& tee -a $SIGN_LOGFILE
Err=$?
if [ $Err -ne 0 ] ; then
        echo_err "Failed <$Err>."
        exit 1
fi


# mv "${ROOT}.${SUFX}" "$ROOT"
echo_dbg "Create gpg file."
if gpg -abs  --output ${ROOT}.gpg "${TARGET}" |& tee -a $SIGN_LOGFILE1 ; then
        rm $TARGET
fi
